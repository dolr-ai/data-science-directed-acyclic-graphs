name: Deploy to Airflow-1

on:
  push:
    branches:
      - self-hosted-airflow

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 138.201.128.108 >> ~/.ssh/known_hosts

      - name: Deploy to airflow-1
        run: |
          ssh -i ~/.ssh/id_rsa root@138.201.128.108 << 'EOF'
            set -e
            
            cd /root/data-science-directed-acyclic-graphs || exit 1
            
            echo "Pulling latest changes..."
            git fetch origin
            git checkout self-hosted-airflow
            git reset --hard origin/self-hosted-airflow
            
            echo "Creating GCP credentials file..."
            echo '${{ secrets.YRAL_DATA_SCIENCE_GOOGLE_CLOUD_PROJECT_EVENTS_BQ_SERVICE_ACCOUNT_KEY }}' > gcp-key.json
            chmod 600 gcp-key.json
            
            echo "Restarting Airflow..."
            AIRFLOW_ADMIN_PASSWORD='${{ secrets.AIRFLOW_ADMIN_PASSWORD }}' docker compose down
            AIRFLOW_ADMIN_PASSWORD='${{ secrets.AIRFLOW_ADMIN_PASSWORD }}' docker compose up -d
            
            echo "Deployment complete!"
          EOF

      - name: Wait for services
        run: sleep 30

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/id_rsa root@138.201.128.108 << 'EOF'
            docker ps
            echo "Checking Airflow health..."
            curl -f http://localhost:8080/health || echo "Airflow not yet ready"
          EOF

      - name: Check HTTPS endpoint
        run: |
          echo "Checking https://airflow-1.yral.com/health..."
          curl -f https://airflow-1.yral.com/health || echo "HTTPS endpoint not yet ready (DNS/TLS may need time)"
